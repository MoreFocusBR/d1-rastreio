<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<div style="width: 100%;" class="shop-tracking-status">
<div class="col-sm-12" style="width: 100%; float: left; background-color: transparent; border: none; display: block;">
<div style="float: left; width: 90%;" class="form-horizontal">
<div class="form-group">
<div style="width: 100%;" id="formNumeroControle">
<div style="margin-top: 2em;" class=""><form name="rastrear_form" id="rastrear_form" action="" method="post">
<div class="col-md-12"><img src="https://www.datafrete.com.br/d1fitness/d1fitness.png" class="col-md-2" id="imgLogo">
<div class="col-md-3 formCabecalho"><label for="tipo_documento">Tipo Documento</label><select name="tipo_documento" id="tipo_documento" class="form-control">
<option value="1">CPF</option>
<option value="2">CNPJ</option>
<option value="3">Pedido</option>
<option value="4">Nota Fiscal (Série / Número)</option>
<option value="41">Nota Fiscal (Chave)</option>
<option value="5">Conhecimento de Transporte (Número)</option>
<option value="51">Conhecimento de Transporte (Chave)</option>
<option value="6">Objeto CORREIOS</option>
</select></div>
<div class="col-md-3 formCabecalho" id="divNumeroDocumento"><label for="numero_documento">Documento</label> <input required="" name="numero_documento" id="numero_documento" type="text" maxlength="25" placeholder="Informe o número do documento" class="form-control"></div>
<div id="rastrearDiv" class="col-md-1 formCabecalho"><input style="background-color: #ff5116; color: #fff; font-weight: bold;" value="Rastrear" class="btn cssPedidoStatusFundoCor" type="submit"></div>
</div>
</form></div>
</div>
</div>
</div>
</div>
<div style="width: 100%; float: left; background-color: transparent; border-bottom: none; border-left: none; border-right: none;" class="well col-sm-12">
<ul style="line-height: 60%;" class="list-group">
<ul style="line-height: 60%;" class="list-group">
<li style="padding: 0px;" class="list-group-item">
<h4 style="font-weight: bold; font-size: 1em; color: #fff;"><span style="color: #000000;" id="titulo_documento_descricao">Pedido</span><span class="glyphicon glyphicon-minus" style="float: right;"></span></h4>
</li>
</ul>
</ul>
<div class="collapse in" style="border: 1px solid #d9d9d9; padding: 5px; margin-bottom: 5px;" id="showHideDivOne">
<li class="list-group-item"><span class="prefix">Transportadora:</span> <span id="nome_transportador" style="line-height: 100%;">-</span></li>
<li class="list-group-item"><span class="prefix">Última atualização em:</span> <span id="ultima_atualizacao_data" style="line-height: 100%;">-</span></li>
<li class="list-group-item"><span class="prefix">Status:</span> <span id="ultima_atualizacao_status" style="line-height: 100%;">-</span></li>
<li class="list-group-item"><span class="prefix">Local de destino:</span> <span id="destino" style="line-height: 100%;">-</span></li>
<li id="div_data_previsao" style="display: none;" class="list-group-item"><span class="prefix">Data prevista para entrega:</span> <span id="data_previsao" style="line-height: 100%;">-</span></li>
<li id="link_rastreio" style="display: none;" class="list-group-item"><span class="prefix">Maiores informações sobre a entrega:</span> <span style="line-height: 100%;"><a rel="noopener noreferrer" id="link_rastreio_anchor" target="_blank">Rastreio transportadora</a></span></li>
<br><br>
<div style="margin-bottom: -1em !important;" class="order-status">
<div style="font-size: 0.7em;" class="image-order-status image-order-status-new active img-circle"><span class="status">Aprovado</span></div>
<div style="font-size: 0.7em;" class="image-order-status image-order-status-active active img-circle"><span class="status">Faturado</span></div>
<div style="font-size: 0.7em;" class="image-order-status image-order-status-intransit active img-circle"><span class="status">Enviado</span></div>
<div style="font-size: 0.7em;" class="image-order-status image-order-status-delivered active img-circle"><span class="status">Entregue</span></div>
</div>
<div class="order-status">
<div class="order-status-timeline">
<div id="status-timeline" class="order-status-timeline-completion c0"></div>
</div>
<div id="status-0" style="font-size: 0.8em;" class="image-order-status image-order-status-new active img-circle"><br><br>
<div class="icon iconInactive" style="background-size: 2em;"></div>
</div>
<div id="status-1" style="font-size: 0.8em;" class="image-order-status image-order-status-active active img-circle"><br><br>
<div class="icon iconInactive" style="background-size: 3.2em; background-repeat: no-repeat;"></div>
</div>
<div id="status-2" style="font-size: 0.8em;" class="image-order-status image-order-status-intransit active img-circle"><br><br>
<div class="icon iconInactive" style="background-size: 2em;"></div>
</div>
<div id="status-3" style="font-size: 0.8em;" class="image-order-status image-order-status-delivered active img-circle"><br><br>
<div class="icon iconInactive" style="background-size: 5em;"></div>
</div>
</div>
<button data-target="#detalhes" data-toggle="collapse" style="margin-bottom: 6px; background-color: #ff5116; color: #fff; font-weight: bold;" class="btn cssPedidoStatusFundoCor" type="button"> Visualizar Histórico </button>
<div id="detalhes" class="bs-example collapse in">
<div class="panel panel-default">
<table id="tabela_historico" class="table table-hover table-condensed table-striped">
<thead>
<tr style="font-weight: bold; color: #919191;">
<th>Data/Hora</th>
<th>Status</th>
<th>Observação</th>
</tr>
</thead>
<tbody id="tabela_historico_body"></tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" type="text/javascript"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.15/jquery.mask.min.js" type="text/javascript"></script> <script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js"></script> <script type="text/javascript">// <![CDATA[
$(document).ready(function () {
            $('#numero_documento').mask('999.999.999-99');

            //var filial_id = 1;
            var empresa_id = "1,2";
            var api_tracking_url = 'localhost:3334/retornaStatusEntregaBlip?cpfcnpj=';

            $.urlParam = function (name) {
                var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
                if (results) {
                    return results[1] || 0;
                } else {
                    return null;
                }
            };

            $('#tipo_documento').change(function () {
                var val = $(this).val();
                $('#numero_documento').val('');

                aplicarMascaraTipoDocumento(val);
            });

            $('#bt_abrir_modal_entender_entrega').on('click', function () {
                $('#modal_entender_entrega').css('display', 'block');
            });

            $(document).on('click', '#divSH0 , #divSH1 , #divSH2 , #divSH3 , #divSH4 , #divSH5', function () {
                if ($(this).find('span').hasClass('glyphicon-minus')) {
                    $(this).find('.glyphicon-minus').removeClass('glyphicon-minus').addClass('glyphicon-plus');
                } else {
                    $(this).find('.glyphicon-plus').removeClass('glyphicon-plus').addClass('glyphicon-minus');
                }
            });

            $('#rastrear_form').submit(function () {
                rastrear();
                return false;
            });

            buscarInformacoesConfig();
            verificarParametros();

            function buscarInformacoesConfig() {
                $.ajax({
                    type: 'GET',
                    dataType: 'json',
                    url: api_tracking_url + 'buscar-configuracoes?empresa_id=' + empresa_id,
                    success: function (resposta) {
                        if (resposta.success) {
                            atualizarCampos(resposta);
                            rastrear();
                        }
                    },
                    error: function (response) {},
                });
            }

            function verificarParametros() {
                let tipo_documento = $.urlParam('tpDoc');
                let numero_documento = $.urlParam('cod');

                if (tipo_documento && numero_documento) {
                    aplicarMascaraTipoDocumento(tipo_documento);
                    $('#tipo_documento').val(tipo_documento);
                    $('#numero_documento').val(numero_documento);
                }
            }

            function atualizarCampos(resposta) {
                $('#tituloPagina').text(resposta.titulo);
                $('#emailAnchor').attr('href', 'mailto:' + resposta.email);
                $('#emailAnchor').text(resposta.email);
                $('#telefone').text('Telefone: ' + resposta.telefone);

                if (resposta.atendimento1) {
                    $('#atendimento1').text(resposta.atendimento1);
                }
                if (resposta.atendimento2) {
                    $('#atendimento2').text(resposta.atendimento2);
                }

                if (resposta.icone) {
                    $('#favicon').attr('href', resposta.icone);
                }

                var informacoes_adicionais = resposta.informacoes_adicionais;
                if (informacoes_adicionais) {
                    var informacoes_adicionais_texto = '';
                    for (var i = 0; i < informacoes_adicionais.length; i++) {
                        informacoes_adicionais_texto += '• ' + informacoes_adicionais[i] + '<br />';
                    }
                    $('#informacoes_adicionais').html(informacoes_adicionais_texto);
                    $('#informacoes_adicionais').show();
                } else {
                    $('#informacoes_adicionais').hide();
                    $('#informacoes_adicionais').html('');
                }

                if (resposta.explicar_entrega_url_img) {
                    $('#explicar_entrega_img').attr('src', resposta.explicar_entrega_url_img);
                    $('#explicar_entrega_div').show();
                } else {
                    $('#explicar_entrega_div').hide();
                }
            }

            function rastrear() {
                let tipo_documento = $('#tipo_documento').val();
                let numero_documento = $('#numero_documento').val();

                if (!tipo_documento || !numero_documento) {
                    return false;
                }

                $('html,body').css('cursor', 'wait');

                $('#rastrear_form :input').prop('disabled', true);
                $.ajax({
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        tipo_documento: tipo_documento,
                        numero_documento: numero_documento,
                        filial_id: 1,
                        "empresa_id" : empresa_id//#ALTERAR - VERIFICAR SE E NECESSARIO
                        //,"numero_cpfcnpjcliente": numero_cpfcnpj//#ALTERAR - VERIFICAR SE E NECESSARIO
                    }, //, "filial_id" : 0
                    url: api_tracking_url + 'rastrear',
                    success: function (resposta) {
                        $('#rastrear_form :input').prop('disabled', false);
                        $('html,body').css('cursor', 'default');
                        if (resposta.dados) {
                            var dados = resposta.dados;

                            $('#titulo_documento_descricao').html(
                                dados.tipo_documento_desc + ' ' + dados.numero_documento
                            );
                            $('#nome_transportador').html(dados.nome_transportador ? dados.nome_transportador : '-');
                            $('#ultima_atualizacao_data').html(
                                dados.ultima_atualizacao_data ? dados.ultima_atualizacao_data : '-'
                            );
                            $('#ultima_atualizacao_status').html(
                                dados.ultima_atualizacao_status ? dados.ultima_atualizacao_status : '-'
                            );
                            $('#destino').html(dados.destino ? dados.destino : '-');

                            if (dados.link_rastreio) {
                                $('#link_rastreio_anchor').attr('href', dados.link_rastreio);
                                $('#link_rastreio').show();
                            } else {
                                $('#link_rastreio_anchor').attr('href', '');
                                $('#link_rastreio').hide();
                            }

                            $('#data_previsao').html(dados.previsao_entrega_exibicao ? dados.previsao_entrega_exibicao : '-');
                            if (dados.previsao_entrega_exibicao) {
                                $('#div_data_previsao').show();
                            } else {
                                $('#div_data_previsao').hide();
                            }

                            ajustarIconesTimeline(dados);
                            //ajustarBotoesDownload(dados.nota_fiscal_id);
                            ajustarTabelaHistorico(dados.historico);
                            mostrarOutrosPedidos(dados.outros_pedidos);
                        } else {
                            alert('Não foi possível encontrar os dados do documento.');
                        }
                    },
                    error: function (response) {
                        $('#rastrear_form :input').prop('disabled', false);
                        $('html,body').css('cursor', 'default');
                        alert('Não foi possível encontrar os dados do documento.');
                    },
                });
            }

            function ajustarIconesTimeline(dados) {
                $('#status-timeline')
                    .removeClass('c0')
                    .removeClass('c1')
                    .removeClass('c2')
                    .removeClass('c3')
                    .removeClass('c4');
                $('.status-div span').removeClass('statusOk');
                $('.status-div div').addClass('iconInactive');
                $('#status-0 div , #status-1 div , #status-2 div , #status-3 div , #status-4 div').addClass(
                    'iconInactive'
                );

                if (dados.status_codigo > -1) {
                    // Aprovado
                    $('#status-0 span').addClass('statusOk');
                    $('#status-0 div').removeClass('iconInactive');
                    $('#status-timeline').addClass('c0');
                }
                if (dados.status_codigo > 0) {
                    // Faturado
                    $('#status-1 span').addClass('statusOk');
                    $('#status-1 div').removeClass('iconInactive');
                    $('#status-timeline').addClass('c1');
                }
                if (dados.status_codigo > 1) {
                    // Enviado
                    $('#status-2 span').addClass('statusOk');
                    $('#status-2 div').removeClass('iconInactive');
                    $('#status-timeline').addClass('c2');
                }
                if (dados.status_codigo > 2) {
                    // Entregue
                    $('#status-3 span').addClass('statusOk');
                    $('#status-3 div').removeClass('iconInactive');
                    $('#status-timeline').addClass('c3');
                }
                if (dados.status_codigo > 3) {
                    // Completo
                    $('#status-4 span').addClass('statusOk');
                    $('#status-4 div').removeClass('iconInactive');
                    $('#status-timeline').addClass('c4');
                }
            }

            /*function ajustarBotoesDownload(nota_fiscal_id) {
                if(nota_fiscal_id) {
                    $("#bt_download_xml").attr("nf_id", nota_fiscal_id);
                    $("#bt_download_pdf").attr("nf_id", nota_fiscal_id);
                    $("#bt_download_xml").show();
                    $("#bt_download_pdf").show();
                } else {
                    $("#bt_download_xml").removeAttr("nf_id");
                    $("#bt_download_pdf").removeAttr("nf_id");
                    $("#bt_download_xml").hide();
                    $("#bt_download_pdf").hide();
                }
            }*/

            function ajustarTabelaHistorico(historico) {
                $('#tabela_historico_body').html('');
                if (historico) {
                    var item_historico;
                    for (var i = 0; i < historico.length; i++) {
                        item_historico = historico[i];
                        var linha =
                            '<tr><td>' +
                            item_historico.dataHora +
                            '</td><td>' +
                            item_historico.status +
                            '</td><td>' +
                            item_historico.observacao +
                            '</td></tr>';
                        $('#tabela_historico_body').append(linha);
                    }
                }
            }

            function exportar_documento(nota_fiscal_id, tipo_arquivo) {
                if (nota_fiscal_id) {
                    $('html,body').css('cursor', 'wait');
                    $.ajax({
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            tipo_documento: tipo_arquivo,
                            nota_fiscal_id: nota_fiscal_id,
                            filial_id: filial_id,
                        },
                        url: api_tracking_url + 'pode-exportar-documento',
                        success: function (resposta) {
                            if (resposta.success) {
                                window.open(
                                    api_tracking_url +
                                        'download-documento/?tipo_arquivo=' +
                                        tipo_arquivo +
                                        '&nota_fiscal_id=' +
                                        nota_fiscal_id +
                                        '&filial_id=' +
                                        filial_id,
                                    '_blank'
                                );
                            } else {
                                alert('Documento não está disponível para download.');
                            }
                            $('html,body').css('cursor', 'default');
                        },
                        error: function (response) {
                            alert('Falha na requisição. Tente novamente');
                            $('html,body').css('cursor', 'default');
                        },
                    });
                } else {
                    alert('Documento não está disponível para download.');
                }
            }

            $(document).on('click', '#bt_download_xml', function () {
                exportar_documento($(this).attr('nf_id'), 'XML');
            });

            $(document).on('click', '#bt_download_pdf', function () {
                exportar_documento($(this).attr('nf_id'), 'PDF');
            });

            function mostrarOutrosPedidos(pedidos) {
                var body = '';
                if (pedidos) {
                    var count = 1;
                    for (i = 0; i < pedidos.length; i++) {
                        var infoHtml = '';
                        var title = '';

                        if (pedidos[i].tipo_documento == 3) {
                            title = 'Pedido ' + pedidos[i]['numero_documento'];
                        } else if (pedidos[i].tipo_documento == 4) {
                            title = 'Nota Fiscal ' + pedidos[i]['numero_documento'];
                        }

                        body +=
                            '<li class="list-group-item" style="padding:0px;">' +
                            '<button style="text-align: left;" type="button" id="divSH' +
                            count +
                            '" class="showHide" data-toggle="collapse" data-target="#divShowHide' +
                            count +
                            '" aria-expanded="true" aria-controls="#showHideDiv' +
                            count +
                            '">' +
                            '<h4 style="font-weight: bold; color: #333333; text-aling:left;">' +
                            '<span>' +
                            title +
                            '</span>' +
                            '<span style="float:right;" class="glyphicon glyphicon-plus"></span>' +
                            '</h4>' +
                            '</button>' +
                            '</li>' +
                            '<div id="divShowHide' +
                            count +
                            '" style="border: 1px solid #d9d9d9; padding: 5px; margin-bottom: 5px;" class="accordion-body collapse">';

                        var arrayTitle = [
                            'Transportadora',
                            'Última atualização em',
                            'Status',
                            'Local de destino',
                            'Data prevista para entrega',
                        ];
                        var arrayVar = [
                            'nome_transportador',
                            'ultima_atualizacao_hora',
                            'ultima_atualizacao_status',
                            'destino',
                            'dt_pedidoprevisao',
                        ];
                        for (j = 0; j < arrayTitle.length; j++) {
                            if (pedidos[i][arrayVar[j]]) {
                                var paramsVal =
                                    typeof pedidos[i][arrayVar[j]] != 'undefined' ? pedidos[i][arrayVar[j]] : '';
                                infoHtml +=
                                    '<li class="list-group-item showHideDiv' +
                                    count +
                                    '">' +
                                    '<span class="prefix">' +
                                    arrayTitle[j] +
                                    ': </span>' +
                                    '<span style="line-height: 100%">' +
                                    paramsVal +
                                    '</span>' +
                                    '</li>';
                            }
                        }

                        if (pedidos[i]['link_rastreio']) {
                            infoHtml +=
                                '<li class="list-group-item showHideDiv' +
                                count +
                                '">' +
                                '<span class="prefix">Maiores informações sobre a entrega: </span>' +
                                '<span style="line-height: 100%"><a href="' +
                                pedidos[i]['link_rastreio'] +
                                '" target="_blank">Rastreio transportadora</a></span>' +
                                '</li>';
                        }

                        body += infoHtml;

                        body += '<div class="order-status">';
                        body += '<div class="order-status-timeline">';
                        body +=
                            '<div class="order-status-timeline-completion c' + pedidos[i]['status_codigo'] + '"></div>';
                        body += '</div>';

                        var statusImg = [
                            'image-order-status-new',
                            'image-order-status-active',
                            'image-order-status-intransit',
                            'image-order-status-delivered',
                            'image-order-status-completed',
                        ];
                        var statusLabel = ['Aprovado', 'Faturado', 'Enviado', 'Entregue', 'Completo'];
                        var statusStyle = [
                            '',
                            'style="background-size: 2.0em;"',
                            'style="background-size: 3.2em;background-repeat:no-repeat"',
                            'style="background-size: 2.0em;"',
                            'style="background-size: 5.0em;"',
                            'tyle="background-size: 5.0em;"',
                        ];
                        for (var x = 0; x < statusImg.length; x++) {
                            var isOk = pedidos[i]['status_codigo'] < x ? 'status' : 'status statusOk';
                            var isActive = pedidos[i]['status_codigo'] >= x ? 'icon' : 'icon iconInactive';

                            body +=
                                '<div class="image-order-status ' +
                                statusImg[x] +
                                ' active img-circle" style="font-size: 0.8em">';
                            body += '<span class="' + isOk + '">' + statusLabel[x] + '</span>';
                            body += '<div ' + statusStyle[x] + ' class="' + isActive + '"></div>';
                            body += '</div>';
                        }
                        body += '</div>';

                        body += '<div>';
                        body +=
                            '<button type="button" class="btn cssPedidoStatusFundoCor" style="margin-bottom: 6px; margin-top: -6px;" data-toggle="collapse" data-target="#collapseExample' +
                            count +
                            '" aria-expanded="false" aria-controls="#collapseExample' +
                            count +
                            '">';
                        body += 'Visualizar Histórico';
                        body += '</button>';
                        
                        body += '</div>';

                        body += '<div class="bs-example collapse in" id="collapseExample' + count + '">';
                        body += '<div class="panel panel-default">';
                        body += '<table class="table table-hover table-condensed table-striped">';
                        body += '<thead>';
                        body += '<tr style="font-weight: bold; color: #919191">';
                        body += '<th>Data/Hora</th>';
                        body += '<th>Status</th>';
                        body += '<th>Observação</th>';
                        body += '</tr>';
                        body += '</thead>';

                        body += '<tbody>';
                        for (j = 0; j < pedidos[i]['historico'].length; j++) {
                            var historico = pedidos[i]['historico'][j];
                            body += '<tr>';
                            body += '<td>' + historico['dataHora'] + '</td>';
                            body += '<td>' + historico['status'] + '</td>';
                            body += '<td>' + historico['observacao'] + '</td>';
                            body += '</tr>';
                        }
                        body += '</tbody>';
                        body += '</table>';
                        body += '</div>';
                        body += '</div>';

                        body += '</div>';
                        body += '</div>';
                        count++;
                    }
                }
                $('#outros_pedidos').html(body);
            }
        });

        function aplicarMascaraTipoDocumento(tipo_documento) {
            $('#divNumeroDocumento').removeClass('col-md-4').addClass('col-md-3');

            if (tipo_documento == 1) {
                $('#numero_documento').mask('999.999.999-99');
                $('#numero_documento').prop('placeholder', 'CPF do recebedor');
            } else if (tipo_documento == 2) {
                $('#numero_documento').mask('99.999.999/9999-99');
                $('#numero_documento').prop('placeholder', 'CNPJ do recebedor');
            } else if (tipo_documento == 3) {
                $('#numero_documento').unmask();
                $('#numero_documento').prop('placeholder', 'Número do Pedido');
            } else if (tipo_documento == 4) {
                $('#numero_documento').unmask();
                $('#numero_documento').prop('placeholder', 'Número da Nota fiscal (Série/Número), ex 001/1530');
            } else if (tipo_documento == 5) {
                $('#numero_documento').unmask();
                $('#numero_documento').prop('placeholder', 'Número do Conhecimento de transporte');
            } else if (tipo_documento == 6) {
                $('#numero_documento').mask('AA000000000AA');
                $('#numero_documento').prop('placeholder', 'Código de objeto do Correios');
            } else if (tipo_documento == 41 || tipo_documento == 51) {
                $('#numero_documento').mask('99999999999999999999999999999999999999999999');
                $('#divNumeroDocumento').removeClass('col-md-3').addClass('col-md-4');
                $('#numero_documento').prop('placeholder', 'Chave de acesso (44 números)');
            }
        }
// ]]></script>